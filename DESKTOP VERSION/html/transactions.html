<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transações - Finanza Desktop</title>
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%23667eea'/><text x='50' y='60' text-anchor='middle' fill='white' font-size='40' font-weight='bold'>F</text></svg>">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar will be loaded here -->
        <div id="sidebar"></div>
        
        <div class="main-content">
            <!-- Header will be loaded here -->
            <div id="header"></div>
            
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Transações</h2>
                    <button class="btn btn-primary" onclick="showCreateTransactionModal()">
                        Nova Transação
                    </button>
                </div>
                <div id="transactionsList">
                    <div class="loading"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for creating/editing transactions -->
    <div id="transactionModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Nova Transação</h3>
                <button class="modal-close" onclick="closeTransactionModal()">&times;</button>
            </div>
            <form id="transactionForm">
                <div class="form-group">
                    <label for="transactionDescription" class="form-label">Descrição</label>
                    <input type="text" id="transactionDescription" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="transactionAmount" class="form-label">Valor</label>
                    <input type="number" id="transactionAmount" class="form-input" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="transactionType" class="form-label">Tipo</label>
                    <select id="transactionType" class="form-input" required>
                        <option value="">Selecione o tipo</option>
                        <option value="receita">Receita</option>
                        <option value="despesa">Despesa</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="transactionAccount" class="form-label">Conta</label>
                    <select id="transactionAccount" class="form-input" required>
                        <option value="">Selecione a conta</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="transactionCategory" class="form-label">Categoria</label>
                    <select id="transactionCategory" class="form-input" required>
                        <option value="">Selecione a categoria</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="transactionDate" class="form-label">Data</label>
                    <input type="date" id="transactionDate" class="form-input" required>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Salvar</button>
                    <button type="button" class="btn btn-secondary ml-2" onclick="closeTransactionModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/navigation.js"></script>
    <script>
        // Initialize components
        const auth = new FinanzaAuth();
        const nav = new FinanzaNavigation();
        let currentEditingTransaction = null;
        let accounts = [];
        let categories = [];
        
        // Check authentication
        if (!auth.requireAuth()) {
            return;
        }
        
        // Initialize page
        async function initTransactionsPage() {
            try {
                const currentUser = await auth.getCurrentUser();
                if (!currentUser) {
                    auth.logout();
                    return;
                }
                
                document.getElementById('sidebar').innerHTML = nav.generateSidebar(currentUser);
                document.getElementById('header').innerHTML = nav.generateHeader('Transações', currentUser);
                
                // Load data
                await Promise.all([
                    loadTransactions(),
                    loadAccounts(),
                    loadCategories()
                ]);
                
                // Set default date to today
                document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
                
            } catch (error) {
                console.error('Error initializing transactions page:', error);
            }
        }
        
        // Load transactions
        async function loadTransactions() {
            try {
                const transactions = await auth.api.getTransactions();
                
                if (transactions.length === 0) {
                    document.getElementById('transactionsList').innerHTML = `
                        <p class="text-center">Nenhuma transação encontrada.</p>
                    `;
                    return;
                }
                
                const transactionsHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Descrição</th>
                                <th>Valor</th>
                                <th>Tipo</th>
                                <th>Conta</th>
                                <th>Categoria</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${transactions.map(transaction => `
                                <tr>
                                    <td>${new Date(transaction.data).toLocaleDateString('pt-BR')}</td>
                                    <td>${transaction.descricao}</td>
                                    <td style="color: ${transaction.tipo === 'receita' ? '#48bb78' : '#f56565'};">
                                        ${auth.formatCurrency(transaction.valor)}
                                    </td>
                                    <td>
                                        <span style="color: ${transaction.tipo === 'receita' ? '#48bb78' : '#f56565'};">
                                            ${transaction.tipo === 'receita' ? 'Receita' : 'Despesa'}
                                        </span>
                                    </td>
                                    <td>${transaction.conta_nome}</td>
                                    <td>${transaction.categoria_nome}</td>
                                    <td>
                                        <button class="btn btn-secondary" style="font-size: 0.8rem; padding: 0.5rem;" onclick="editTransaction(${transaction.id})">Editar</button>
                                        <button class="btn btn-danger ml-1" style="font-size: 0.8rem; padding: 0.5rem;" onclick="deleteTransaction(${transaction.id})">Excluir</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                document.getElementById('transactionsList').innerHTML = transactionsHTML;
                
            } catch (error) {
                console.error('Error loading transactions:', error);
                auth.showError('Erro ao carregar transações');
            }
        }
        
        // Load accounts for dropdown
        async function loadAccounts() {
            try {
                accounts = await auth.api.getAccounts();
                const accountSelect = document.getElementById('transactionAccount');
                accountSelect.innerHTML = '<option value="">Selecione a conta</option>';
                
                accounts.forEach(account => {
                    accountSelect.innerHTML += `<option value="${account.id}">${account.nome}</option>`;
                });
            } catch (error) {
                console.error('Error loading accounts:', error);
            }
        }
        
        // Load categories for dropdown
        async function loadCategories() {
            try {
                categories = await auth.api.getCategories();
                const categorySelect = document.getElementById('transactionCategory');
                categorySelect.innerHTML = '<option value="">Selecione a categoria</option>';
                
                categories.forEach(category => {
                    categorySelect.innerHTML += `<option value="${category.id}">${category.nome}</option>`;
                });
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }
        
        // Show create transaction modal
        function showCreateTransactionModal() {
            currentEditingTransaction = null;
            document.getElementById('modalTitle').textContent = 'Nova Transação';
            document.getElementById('transactionForm').reset();
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('transactionModal').classList.remove('hidden');
        }
        
        // Edit transaction
        async function editTransaction(transactionId) {
            try {
                const transactions = await auth.api.getTransactions();
                const transaction = transactions.find(t => t.id === transactionId);
                
                if (transaction) {
                    currentEditingTransaction = transaction;
                    document.getElementById('modalTitle').textContent = 'Editar Transação';
                    document.getElementById('transactionDescription').value = transaction.descricao;
                    document.getElementById('transactionAmount').value = transaction.valor;
                    document.getElementById('transactionType').value = transaction.tipo;
                    document.getElementById('transactionAccount').value = transaction.conta_id;
                    document.getElementById('transactionCategory').value = transaction.categoria_id;
                    document.getElementById('transactionDate').value = transaction.data.split('T')[0];
                    document.getElementById('transactionModal').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading transaction for editing:', error);
            }
        }
        
        // Delete transaction
        async function deleteTransaction(transactionId) {
            if (confirm('Tem certeza que deseja excluir esta transação?')) {
                try {
                    await auth.api.deleteTransaction(transactionId);
                    await loadTransactions();
                } catch (error) {
                    console.error('Error deleting transaction:', error);
                    auth.showError('Erro ao excluir transação');
                }
            }
        }
        
        // Close transaction modal
        function closeTransactionModal() {
            document.getElementById('transactionModal').classList.add('hidden');
            currentEditingTransaction = null;
        }
        
        // Handle transaction form submission
        document.getElementById('transactionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const description = document.getElementById('transactionDescription').value;
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            const type = document.getElementById('transactionType').value;
            const accountId = parseInt(document.getElementById('transactionAccount').value);
            const categoryId = parseInt(document.getElementById('transactionCategory').value);
            const date = document.getElementById('transactionDate').value;
            
            try {
                const transactionData = {
                    descricao: description,
                    valor: amount,
                    tipo: type,
                    conta_id: accountId,
                    categoria_id: categoryId,
                    data: date
                };
                
                if (currentEditingTransaction) {
                    await auth.api.updateTransaction(currentEditingTransaction.id, transactionData);
                } else {
                    await auth.api.createTransaction(transactionData);
                }
                
                closeTransactionModal();
                await loadTransactions();
                
            } catch (error) {
                console.error('Error saving transaction:', error);
                auth.showError('Erro ao salvar transação');
            }
        });
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initTransactionsPage);
    </script>
</body>
</html>